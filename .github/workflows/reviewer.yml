name: reviwer

on:
  pull_request:
    types:
      - edited
      - review_requested
      - synchronize

jobs:
  reviewer:
    runs-on: ubuntu-latest
    env:
      pullnumber: ${{ github.event.pull_request.number }}
      org: "mrngshtorg"
      repo: "mrngshttest"
      team: "all"
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: getmembers
        id: getmembers
        env:
          GITHUB_TOKEN: ${{ secrets.TEAM_READ_TOKEN }}
        run: |
          teamslug="${org}/${team}"
          if gh pr view "${pullnumber}" --json reviewRequests | jq -r '.reviewRequests[].slug' | grep $teamslug; then
            members=$(gh api -X GET "/orgs/$org/teams/$team/members" | jq -c '[.[].login | select(. != "${{ github.actor }}")]')
            echo ::set-output name=members::$members
          fi 

          # ${{ github.owner }}/${{ github.repository }}

      - name: setmembers
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          curl -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"\
            -H "X-GitHub-Api-Version: 2022-11-28" \
            https://api.github.com/repos/${org}/${repo}/pulls/${pullnumber}/requested_reviewers \
            -d '{"reviewers": ${{ steps.getmembers.outputs.members }} }'
